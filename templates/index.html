<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouTube Chapter Splitter</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
  <h2>YouTube Audio Chapter Splitter</h2>
  <div class="mb-3">
    <input id="url" class="form-control" placeholder="Enter YouTube URL" />
  </div>
  <button id="btn" class="btn btn-primary">Download & Split</button>
  <div id="prog" class="progress mt-3" style="display:none; height: 25px;">
    <div id="bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
  </div>
  <div id="msg" class="mt-3"></div>

  <script>
    const btn = document.getElementById('btn'),
          prog = document.getElementById('prog'),
          bar = document.getElementById('bar'),
          msg = document.getElementById('msg');

    btn.addEventListener('click', async () => {
      msg.innerHTML = '';
      prog.style.display = 'block';
      bar.style.width = '0%';
      bar.innerText = '0%';
      btn.disabled = true;
      btn.innerText = 'Working...';

      const url = document.getElementById('url').value.trim();
      const res = await fetch('/start', {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ youtube_url: url })
      });
      if (!res.ok) return showError((await res.json()).error);

      const { task_id } = await res.json();
      (function poll() {
        fetch(`/progress/${task_id}`)
          .then(r => r.json())
          .then(d => {
            if (d.error) return showError(d.error);
            if (d.status === 'done') {
              bar.style.width = '100%'; bar.innerText = '100%';
              fetchResult(task_id);
            } else if (d.status === 'error') {
              showError(d.error || 'An error occurred');
            } else {
              setTimeout(poll, 800);
            }
          });
      })();
    });

    async function fetchResult(id) {
      let r = await fetch(`/result/${id}`),
          d = await r.json();
      if (d.error) return showError(d.error);

      const rlt = d.result;
      // Build UI with both ZIP link and individual-file list
      const listItems = rlt.files
        .map(f => `
          <li>
            <a href="/download/${encodeURIComponent(rlt.path)}/${encodeURIComponent(f)}" download>
              ${f}
            </a>
          </li>
        `).join('');

      msg.innerHTML = `
        <div class="alert alert-success">
          <h5>✅ Download complete!</h5>
          <p><strong>Video:</strong> ${rlt.video_title}</p>
          <p><strong>Download ZIP:</strong>
            <a href="/download/zip/${encodeURIComponent(rlt.path)}" download>
              ${rlt.video_title}.zip
            </a>
          </p>
          <p><strong>Individual Files:</strong></p>
          <ul>
            ${listItems}
          </ul>
          <p><strong>Time:</strong> ${rlt.total_time} s</p>
          <p><strong>Space:</strong> ${rlt.total_space} MB</p>
        </div>`;
      btn.disabled = false;
      btn.innerText = 'Download & Split';
    }

    function showError(txt) {
      prog.style.display = 'none';
      msg.innerHTML = `<div class="alert alert-danger">❌ ${txt}</div>`;
      btn.disabled = false;
      btn.innerText = 'Download & Split';
    }
  </script>
</body>
</html>
